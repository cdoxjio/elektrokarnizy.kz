<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>The MS-700 certification</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: 'Segoe UI', Arial, sans-serif; }
    .fade { transition: all 0.5s; }
    .question-area { max-width: 1200px; margin: 0 auto; }
    .question-area p { margin-bottom: 0.7em; }
    .mint-bg {
      background: linear-gradient(120deg, #e6fff4 0%, #f6fefc 100%);
    }
    .groups-link-bar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(110px, 1fr));
      gap: 0.5em;
      justify-items: center;
      align-items: center;
      margin-bottom: 0.1em;
      margin-top: 2em;
    }
    .group-link {
      padding: 0.1em 0.7em;
      border-radius: 6px;
      font-size: 1em;
      text-decoration: underline dotted;
      color: #205070;
      background: none;
      border: none;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
      outline: none;
      user-select: none;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-weight: 600;
    }
    .group-link.active {
      color: #fff;
      background: #B22234;
      text-decoration: none;
      font-weight: bold;
    }
    .group-link:focus-visible {
      outline: 2px solid #B22234;
      outline-offset: 1px;
    }
    .random-link {
      padding: 0.1em 0.7em;
      border-radius: 6px;
      font-size: 1em;
      color: #137ca8;
      text-decoration: underline dotted;
      cursor: pointer;
      font-weight: 600;
      letter-spacing: 0.01em;
      background: none;
      border: none;
      margin-top: 0.7em;
      margin-bottom: 1em;
      margin-left: 0.3em;
      margin-right: 0.3em;
      font-family: 'Segoe UI', Arial, sans-serif;
      transition: color 0.15s;
      display: inline-block;
    }
    .random-link:hover { color: #1e80c1; }
    /* остальные стили не изменялись */
  </style>
</head>
<body class="mint-bg min-h-screen flex flex-col items-center">
  <div id="app" class="w-full flex flex-col items-center justify-center min-h-screen"></div>
  <div id="footerInfo"></div>
<script>
const QUESTIONS = [];
let QUESTIONS_LOADED = false;
let LOAD_ERROR = false;
let allQuestionsMode = false;

fetch('ms700_questions.json')
  .then(r => r.json())
  .then(qs => { QUESTIONS.push(...qs); QUESTIONS_LOADED = true; start(); })
  .catch(() => {
    LOAD_ERROR = true;
    render();
  });

function chunkArray(array, size) {
  const result = [];
  for (let i = 0; i < array.length; i += size) {
    result.push(array.slice(i, i + size));
  }
  return result;
}
function shuffle(arr) {
  let a = arr.slice();
  for (let i = a.length - 1; i > 0; i--) {
    let j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}
const ABC = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('');

// --- Основная правка: только валидные вопросы, формируем группы динамически ---
function start() {
  allQuestionsMode = false;
  // только валидные вопросы, случайный порядок
  const validQuestions = shuffle(QUESTIONS).filter(q =>
    q && q.question && typeof q.question === 'string' && q.question.trim().length &&
    q.answers && Array.isArray(q.answers) && q.answers.length
  );
  groups = chunkArray(validQuestions, 20);
  groupIdx = 0;
  goToGroup(0);
}
// -----------------------------------------------------------------------------

let groupIdx = 0, qIdx = 0, showAnswer = false, groupResults = [], timer = 0, timeActive = true;
let interval = null, groups = [], group = [], q = {};
let allSelected = [];
let retryMode = false;

function getCurrentGroupStats() {
  let ok = 0, err = 0;
  for (let i = 0; i < groupResults.length; i++) {
    if (groupResults[i] === true) ok++;
    if (groupResults[i] === false) err++;
  }
  return {ok, err};
}

function render() {
  const app = document.getElementById('app');
  app.innerHTML = '';

  document.getElementById('footerInfo').innerHTML = `
    <div class="footer-info">
      Questions are collected from open internet sources and provided for personal learning only.
    </div>
  `;

  if (LOAD_ERROR) {
    app.innerHTML = `<div class="mt-20 text-center">
      <div class="text-3xl text-red-700 font-bold mb-2">Failed to load questions</div>
      <div class="text-base text-red-700">Please check your ms700_questions.json file.</div>
    </div>`;
    return;
  }
  if (!QUESTIONS_LOADED) {
    app.innerHTML = `<div class="mt-20 text-center">
      <div class="text-2xl text-gray-600 font-bold mb-3 animate-pulse">Loading questions...</div>
    </div>`;
    return;
  }

  let topTitle = `
    <div class="w-full flex flex-col items-center mb-1 mt-2">
      <div class="main-headline">The MS-700 certification</div>
      <div class="main-subhead">Microsoft 365 Certified: Teams Administrator Associate</div>
    </div>
  `;

  let groupTabs = allQuestionsMode ? '' : `
    <div class="groups-link-bar" role="tablist" aria-label="Question groups">
      ${groups.map((g, idx) =>
        `<a href="javascript:void(0);" role="button" tabindex="0"
            aria-current="${idx===groupIdx ? 'true' : 'false'}"
            class="group-link${idx===groupIdx ? ' active' : ''}"
            onclick="goToGroup(${idx})"
            onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();goToGroup(${idx});}"
        >
            Group ${idx+1}
        </a>`
      ).join('')}
    </div>
    <div style="text-align:center">
      <a class="random-link group-link" onclick="startAllQuestionsRandom()" href="javascript:void(0);">Start test with all questions (random order)</a>
    </div>
  `;

  let backToGroupsLink = allQuestionsMode
    ? `<div style="text-align:center">
         <a class="random-link group-link" onclick="start()" href="javascript:void(0);">Back to groups mode</a>
       </div>` : '';

  app.innerHTML = topTitle + groupTabs + backToGroupsLink + mainContent();
}

// ...все остальные функции (mainContent, formatQuestion и т.д.) без изменений...

// ОСТАЛЬНОЕ БЕЗ ИЗМЕНЕНИЙ
function formatQuestion(text) {
  let paragraphs = [];
  if (text.indexOf('\n\n') >= 0) {
    paragraphs = text.split(/\n{2,}/);
  } else {
    paragraphs = text.split(/([.?!]\s+)/g).reduce((acc, part, idx, arr) => {
      if (part.match(/[.?!]\s+/)) {
        acc[acc.length - 1] += part;
      } else {
        acc.push(part);
      }
      return acc;
    }, []);
  }
  return paragraphs.map(p => `<p>${p.trim()}</p>`).join('');
}

function mainContent() {
  let {ok, err} = getCurrentGroupStats();
  let qStatus = '';
  if (groupResults[qIdx] === true) {
    qStatus = `<span class="mini-badge ok cur-q" title="Correct">✔</span>`;
  } else if (groupResults[qIdx] === false) {
    qStatus = `<span class="mini-badge err cur-q" title="Incorrect">✖</span>`;
  }

  let timerBox = `
    <span class="modern-timer" title="Time spent">
      <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="9" />
        <polyline points="12 7 12 12 15 15" />
      </svg>
      ${Math.floor(timer/60)}:${String(timer%60).padStart(2,'0')}
    </span>
  `;

  let counterBlock = `<div class="flex flex-wrap items-center gap-4 justify-center mb-3">
    <div class="bg-white/70 text-mint-700 px-2 py-0.5 rounded-md text-xs font-semibold border border-mint-200 flex items-center">
      Group ${groupIdx+1}/${groups.length}
      <span class="mini-stats">
        <span class="mini-badge ok" title="Correct in group">✔ ${ok}</span>
        <span class="mini-badge err" title="Incorrect in group">✖ ${err}</span>
      </span>
    </div>
    <div class="bg-white/70 text-mint-700 px-2 py-0.5 rounded-md text-xs font-semibold border border-mint-200 flex items-center">
      Question ${qIdx+1}/${group.length}
      ${qStatus}
    </div>
    ${timerBox}
  </div>`;

  // Остальной код mainContent (рендер вопросов/ответов и т.п.) — без изменений...
  // Здесь можно оставить как в вашей последней версии, это не влияет на количество вкладок.
  // ... (если надо — пришлю полный вариант)

  return counterBlock; // + всё остальное, как было у вас
}

// ОСТАЛЬНОЕ БЕЗ ИЗМЕНЕНИЙ (startAllQuestionsRandom, goToGroup, next, prev и т.п.)

</script>
</body>
</html>
